<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Commodity Price — Live Report</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#f7faf7;margin:20px;}
  .container{max-width:980px;margin:0 auto;background:white;padding:18px;border-radius:8px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  select,button{padding:8px 10px;border-radius:6px;border:1px solid #d1d5db}
  button{background:#0b6b3a;color:white;border:none;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{padding:8px;border-bottom:1px solid #eef2e8;text-align:left}
  .notes{margin-top:12px;font-size:13px;color:#475569}
  .error{color:#b91c1c;font-weight:600}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h3 style="margin:0 0 6px 0">Commodity Price — Live (Google Sheet CSV)</h3>
        <div id="meta" style="color:#64748b;font-size:13px">Make sure sheet is published as CSV.</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label style="font-size:13px;color:#64748b">Select date</label>
        <select id="dateSelect"></select>
        <button id="loadBtn">Load</button>
        <button id="downloadPdf">Download PDF</button>
      </div>
    </header>

    <div style="overflow:auto">
      <table id="priceTable">
        <thead><tr><th>Commodity</th><th>Specification</th><th>Unit</th><th>Price</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="notes" id="notes">Status: waiting to fetch sheet…</div>
  </div>

<script>
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR2B1kT01540Rd4EIE1JmbBGoJVIF_N15yBJ815TaB_N8tViqufx1hksC9J-HcRcN8jvP2QLfl84yQr/pub?gid=1473969119&single=true&output=csv";

function showNote(msg, isError=false){
  const n = document.getElementById('notes');
  n.innerHTML = (isError?'<span class="error">Error:</span> ':'') + msg;
  console.log(msg);
}

// Load PapaParse
const papa = document.createElement('script');
papa.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js';
papa.onload = init;
document.head.appendChild(papa);

let rows = [], headerRow = [], dateColumns = [];

function init(){
  showNote('Loading CSV from Google Sheets...');
  fetchAndParse();
}

async function fetchAndParse(){
  try {
    const res = await fetch(SHEET_CSV, { cache: "no-store" });
    const txt = await res.text();
    if(!txt.trim()) return showNote('Empty CSV, make sure it’s published.', true);

    const parsed = Papa.parse(txt, { skipEmptyLines:false });
    rows = parsed.data.map(r => r.map(c => (c||"").trim()));

    // Find header row dynamically (contains "Commodity")
    const headerIndex = rows.findIndex(r => r.some(c => /commodity/i.test(c))) || 9;
    headerRow = rows[headerIndex] || [];
    showNote(`Detected header row at index ${headerIndex}.`);

    identifyDateColumns(headerIndex);
  } catch (err) {
    console.error(err);
    showNote('❌ Fetch/parsing failed — ' + err.message, true);
  }
}

function parseDateISO(text){
  if(!text) return null;
  const t = String(text).trim();
  const m = t.match(/^([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})$/);
  if(m){
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const idx = months.indexOf(m[1]);
    if(idx >= 0) return new Date(Date.UTC(m[3], idx, m[2])).toISOString().slice(0,10);
  }
  const d = new Date(t);
  return isNaN(d) ? null : d.toISOString().slice(0,10);
}

function identifyDateColumns(headerIndex){
  dateColumns = [];
  for(let i=3; i<headerRow.length; i++){ // Start at D (index 3)
    const iso = parseDateISO(headerRow[i]);
    if(iso) dateColumns.push({index:i, raw:headerRow[i], iso});
  }

  if(dateColumns.length === 0){
    showNote('⚠️ No valid date columns found. Check sheet headers.', true);
    return;
  }

  const sel = document.getElementById('dateSelect');
  sel.innerHTML = dateColumns.map(dc => {
    const label = (new Date(dc.iso)).toLocaleDateString(undefined, {year:'numeric',month:'short',day:'numeric'});
    return `<option value="${dc.index}">${label}</option>`;
  }).join('');

  const latest = dateColumns[dateColumns.length - 1];
  sel.value = latest.index;
  showNote(`✅ Found ${dateColumns.length} date columns. Auto-loading latest.`);

  // Auto-load latest
  renderByColumn(latest.index, headerIndex);

  document.getElementById('loadBtn').addEventListener('click', () => renderByColumn(Number(sel.value), headerIndex));

  // PDF download
  document.getElementById('downloadPdf').addEventListener('click', ()=>{
    const el = document.querySelector('.container');
    if(!window.html2pdf){
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js';
      s.onload = ()=> html2pdf().set({margin:10, filename:`Commodity-Report-${new Date().toISOString().slice(0,10)}.pdf`}).from(el).save();
      document.body.appendChild(s);
    } else {
      html2pdf().set({margin:10, filename:`Commodity-Report-${new Date().toISOString().slice(0,10)}.pdf`}).from(el).save();
    }
  });
}

function renderByColumn(colIndex, headerIndex){
  const tbody = document.querySelector('#priceTable tbody');
  tbody.innerHTML = '';
  let rendered = 0;

  // Start after header row
  for(let r=headerIndex+1; r<rows.length; r++){
    const row = rows[r];
    if(!row || row.length < colIndex) continue;

    const commodity = row[0] || '';
    const spec = row[1] || '';
    const unit = row[2] || '';
    const price = row[colIndex] || '';

    if(commodity && price){
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${commodity}</td>
          <td>${spec}</td>
          <td>${unit}</td>
          <td>${price}</td>
        </tr>
      `);
      rendered++;
    }
  }

  showNote(`✅ Showing ${rendered} items for: ${headerRow[colIndex]}`);
}
</script>
</body>
</html>
