<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Commodity Price — Live Report (CSV debug)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600,700&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:#f7faf7; margin:20px;}
  .container{max-width:980px;margin:0 auto;background:white;padding:18px;border-radius:8px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
  header{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
  select,input,button{padding:8px 10px;border-radius:6px;border:1px solid #d1d5db}
  .download{background:#0b6b3a;color:white;border:none;cursor:pointer}
  .load-btn{background:#2563eb;color:white;border:none;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{padding:8px;border-bottom:1px solid #eef2e8;text-align:left}
  .notes{margin-top:12px;font-size:13px;color:#475569}
  .error{color:#b91c1c;font-weight:600}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h3 style="margin:0 0 6px 0">Commodity Price — Live (Google Sheet CSV)</h3>
        <div id="meta" style="color:#64748b;font-size:13px">Make sure sheet is published to the web as CSV.</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label style="font-size:13px;color:#64748b">Select date</label>
        <select id="dateSelect"></select>
        <button id="loadBtn" class="load-btn">Load</button>
        <button id="downloadPdf" class="download">Download PDF</button>
      </div>
    </header>

    <div style="overflow:auto">
      <table id="priceTable">
        <thead><tr><th>Commodity</th><th>Specification</th><th>Unit</th><th>Price</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="notes" id="notes">Status: waiting to fetch sheet… (open DevTools → Console/Network for raw output)</div>
  </div>

<script>
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR2B1kT01540Rd4EIE1JmbBGoJVIF_N15yBJ815TaB_N8tViqufx1hksC9J-HcRcN8jvP2QLfl84yQr/pub?gid=1473969119&single=true&output=csv";

function showNote(msg, isError=false){
  const n = document.getElementById('notes');
  n.innerHTML = (isError?'<span class="error">Error:</span> ':'') + msg;
  console.log(msg);
}

// load PapaParse for CSV parsing
const papa = document.createElement('script');
papa.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js';
papa.onload = init;
document.head.appendChild(papa);

let rows = [], headerRow = [], dateColumns = [];

function init(){
  showNote('Loading CSV from Google Sheets...');
  fetchAndParse();
}

async function fetchAndParse(){
  try{
    const res = await fetch(SHEET_CSV, {cache: "no-store"});
    console.log('Fetch response:', res.status, res.statusText);
    const txt = await res.text();
    if(!txt || txt.trim().length === 0){
      showNote('Empty CSV. Make sure sheet is published as CSV.', true);
      return;
    }

    const parsed = Papa.parse(txt, {skipEmptyLines:false});
    rows = parsed.data;
    headerRow = rows[9] || []; // row 10 in sheet
    identifyDateColumns();
  } catch (err) {
    console.error(err);
    showNote('❌ Fetch/parsing failed — ' + err.message, true);
  }
}

/* ✅ Improved parser: handles “January 4, 2025”, ISO, Excel serials, etc. */
function parseDateISO(text){
  if(!text) return null;
  const t = String(text).trim();

  // Try native parsing first
  let d = new Date(t);
  if(!isNaN(d)) return d.toISOString().slice(0,10);

  // Try "January 4, 2025" style
  const m = t.match(/^([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})$/);
  if(m){
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const monthIndex = monthNames.indexOf(m[1]);
    if(monthIndex >= 0){
      const dt = new Date(Date.UTC(m[3], monthIndex, m[2]));
      return dt.toISOString().slice(0,10);
    }
  }

  // Try Excel serial number fallback
  const n = Number(t);
  if(!isNaN(n) && n > 1000){
    const excelEpoch = new Date(Date.UTC(1899,11,30));
    const ms = n * 24*3600*1000;
    const dt = new Date(excelEpoch.getTime() + ms);
    return dt.toISOString().slice(0,10);
  }

  return null;
}

function identifyDateColumns(){
  dateColumns = [];
  for(let i=0; i<headerRow.length; i++){
    const iso = parseDateISO(headerRow[i]);
    if(iso){
      dateColumns.push({index:i, raw:headerRow[i], iso});
    }
  }

  if(dateColumns.length === 0){
    showNote('No date-like headers found in row 10. Check your sheet.', true);
    return;
  }

  const sel = document.getElementById('dateSelect');
  sel.innerHTML = dateColumns.map(dc => {
    const label = (new Date(dc.iso)).toLocaleDateString(undefined, {year:'numeric',month:'short',day:'numeric'});
    return `<option value="${dc.index}">${label}</option>`;
  }).join('');

  // ✅ Default to latest date
  const latestIndex = dateColumns[dateColumns.length - 1].index;
  sel.value = latestIndex;
  showNote(`✅ Loaded ${dateColumns.length} date columns. Select a date and click "Load".`);

  // Add listeners
  document.getElementById('loadBtn').addEventListener('click', () => renderByColumn(Number(sel.value)));

  // PDF download
  document.getElementById('downloadPdf').addEventListener('click', ()=>{
    const el = document.querySelector('.container');
    if(!window.html2pdf){
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js';
      s.onload = ()=> html2pdf().set({margin:10, filename:`Commodity-Report-${new Date().toISOString().slice(0,10)}.pdf`}).from(el).save();
      document.body.appendChild(s);
    } else {
      html2pdf().set({margin:10, filename:`Commodity-Report-${new Date().toISOString().slice(0,10)}.pdf`}).from(el).save();
    }
  });
}

function renderByColumn(colIndex){
  if(!rows || rows.length === 0) return showNote('No data to render.');
  if(typeof colIndex !== 'number' || isNaN(colIndex)) return showNote('Invalid date selection.', true);

  const tbody = document.querySelector('#priceTable tbody');
  tbody.innerHTML = '';
  let rendered = 0;

  for(let r=10; r<rows.length; r++){
    const row = rows[r];
    if(!row || row.length === 0) continue;
    const commodity = row[0] || '';
    const spec = row[1] || '';
    const unit = row[2] || '';
    const rawPrice = row[colIndex];
    let price = null;

    if(rawPrice && String(rawPrice).trim() !== ''){
      const cleaned = String(rawPrice).replace(/,/g,'').replace(/[^\d\.\-]/g,'').trim();
      const p = parseFloat(cleaned);
      if(!isNaN(p)) price = p;
    }

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${commodity || '—'}</td>
        <td>${spec || '—'}</td>
        <td>${unit || '—'}</td>
        <td>${price !== null ? price.toFixed(2) : '—'}</td>
      </tr>
    `);
    rendered++;
  }

  showNote(`✅ Showing prices for: ${headerRow[colIndex]} — ${rendered} rows.`);
}
</script>
</body>
</html>
