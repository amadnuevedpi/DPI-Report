<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DA Price Report</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root { --da-green:#0b6623; --light-yellow:#ded371; }

  body {
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:#f0f4f7;
    margin:0; padding:8px;
    font-size:13px;
  }

  /* Non-printable controls */
  .controls {
    background:#fff;
    border-radius:6px;
    padding:10px 14px;
    margin-bottom:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.05);
  }
  @media print { .controls { display:none !important; } }

  select,button {
    padding:6px 10px;
    border-radius:4px;
    border:1px solid #ccc;
    font-size:13px;
  }
  button {
    cursor:pointer;
    background:#0b6623;
    color:#fff;
    border:none;
    font-weight:600;
  }
  button:hover { background:#0a5820; }

  /* Header */
  .top-strip{background:var(--da-green);height:4px;width:100%}
  .yellow-strip{background:var(--light-yellow);height:4px;width:100%}

  .header {
    display:flex;justify-content:space-between;align-items:center;
    padding:8px 16px;background:#fff;margin-bottom:8px;
  }
  .left-block{display:flex;align-items:center;gap:10px}
  .left-block img{height:55px}
  .agency-text{font-size:12px;line-height:1.3}
  .agency-text strong{font-size:13px;display:block;color:var(--da-green)}

  /* Titles */
  .price-monitoring {
    text-align:center;
    background:var(--light-yellow);
    padding:6px;
    font-size:16px;
    font-weight:700;
  }
  .sub-title {
    text-align:center;
    font-size:15px;
    font-weight:700;
    color:#333;
    margin:4px 0;
  }
  .asof {
    text-align:center;
    font-size:12px;
    font-style:italic;
    margin-bottom:6px;
  }

  /* Table */
  .table-container {
    background:#fff;
    border-radius:6px;
    padding:10px;
  }
  table {
    width:100%;
    border-collapse:collapse;
  }
  th,td {
    border:1px solid #ddd;
    padding:6px 8px;
    font-size:12px;
  }
  th {
    background:#0b6623;
    color:#fff;
    text-align:left;
  }

  .notes { margin-top:6px;font-size:12px;color:#555; }
  .error { color:#b91c1c; font-weight:600; }

  /* Footer */
  .footer-logo{display:flex;justify-content:flex-end;padding:6px 20px 0 0}
  .footer-logo img{height:55px}
  footer {
    background:var(--da-green);
    color:white;
    padding:6px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    font-size:11px;
    margin-top:10px;
  }
  footer a {color:white;text-decoration:none}
</style>
</head>

<body>
  <div class="controls">
    <h3 style="margin:0 0 6px 0;font-size:14px;">Agri-Fishery Commodity Retail Price</h3>
    <label style="font-size:12px;margin-right:6px;">Select Date:</label>
    <select id="dateSelect"></select>
    <button id="loadBtn">Load</button>
    <button id="downloadPdf">Download PDF</button>
    <div id="notes" class="notes"></div>
  </div>

  <div id="reportArea">
    <div class="top-strip"></div>
    <div class="yellow-strip"></div>

    <div class="header">
      <div class="left-block">
        <img src="https://raw.githubusercontent.com/amadnuevedpi/DA-AMAD-BP-logos/main/da.png" alt="DA Logo">
        <div class="agency-text">
          <strong>Department of Agriculture</strong>
          AGRIBUSINESS MARKETING ASSISTANCE DIVISION<br>
          Regional Field Office IX<br>
          Lenienza St., Pagadian City
        </div>
      </div>
      <img src="https://raw.githubusercontent.com/amadnuevedpi/DA-AMAD-BP-logos/main/bag%20pil.png" height="55" alt="Bagong Pilipinas">
    </div>

    <div class="price-monitoring">REGION IX AGRI-FISHERY AND CIGARETTES</div>
    <div class="sub-title">DAILY PRICE INDEX REPORT</div>
    <div id="asOfDate" class="asof">As of —</div>

    <div class="table-container">
      <table id="priceTable">
        <thead>
          <tr><th>Commodity</th><th>Specification</th><th>Unit</th><th>Price</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="footer-logo">
      <img src="https://raw.githubusercontent.com/amadnuevedpi/DA-AMAD-BP-logos/main/ZAMPEN%20AMAD.png" alt="Zampen AMAD">
    </div>

    <footer>
      <div class="footer-left">Generated by DA-AMAD Price Monitoring System</div>
      <div><a href="#">Department of Agriculture RFO IX</a></div>
    </footer>
  </div>

<script>
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR2B1kT01540Rd4EIE1JmbBGoJVIF_N15yBJ815TaB_N8tViqufx1hksC9J-HcRcN8jvP2QLfl84yQr/pub?gid=1473969119&single=true&output=csv";

function showNote(msg,isErr=false){
  const el=document.getElementById('notes');
  el.innerHTML=(isErr?'<span class="error">Error:</span> ':'')+msg;
}

const papa=document.createElement('script');
papa.src='https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js';
papa.onload=init;
document.head.appendChild(papa);

let rows=[],headerRow=[],dateColumns=[];

function init(){
  showNote('Loading CSV...');
  fetch(SHEET_CSV,{cache:'no-store'})
    .then(r=>r.text())
    .then(txt=>{
      const parsed=Papa.parse(txt,{skipEmptyLines:false});
      rows=parsed.data;
      headerRow=rows[9]||[];
      identifyDates();
    })
    .catch(e=>showNote(e.message,true));
}

function parseDateISO(t){
  if(!t)return null;
  const s=String(t).trim();
  const d=new Date(s);
  if(!isNaN(d))return d.toISOString().slice(0,10);

  const m=s.match(/^([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})$/);
  if(m){
    const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
    const i=months.indexOf(m[1]);
    if(i>=0)return new Date(Date.UTC(m[3],i,m[2])).toISOString().slice(0,10);
  }
  const n=Number(s);
  if(!isNaN(n)&&n>10000){
    const base=new Date(Date.UTC(1899,11,30));
    return new Date(base.getTime()+n*86400000).toISOString().slice(0,10);
  }
  return null;
}

function identifyDates(){
  dateColumns=[];
  for(let i=3;i<headerRow.length;i++){
    const iso=parseDateISO(headerRow[i]);
    if(iso)dateColumns.push({index:i,iso,label:headerRow[i]});
  }
  if(dateColumns.length===0)return showNote('⚠️ No valid date columns found.',true);

  const sel=document.getElementById('dateSelect');
  sel.innerHTML=dateColumns.map(dc =>
    `<option value="${dc.index}">${dc.label}</option>`
  ).join('');

  sel.value=dateColumns.at(-1).index;

  document.getElementById('loadBtn').addEventListener('click',()=>{
    const idx = Number(sel.value);
    const dc = dateColumns.find(d=>d.index===idx);
    renderByColumn(idx);
    document.getElementById('asOfDate').innerText = `As of ${dc ? dc.label : ''}`;
  });

  // Auto-load last date
  document.getElementById('loadBtn').click();
}

function renderByColumn(i){
  const tb=document.querySelector('#priceTable tbody');
  tb.innerHTML='';
  let c=0;
  for(let r=10;r<rows.length;r++){
    const row=rows[r];
    if(!row||row.length<=i)continue;
    const com=row[0]||'',spec=row[1]||'',unit=row[2]||'',price=row[i]||'';
    if(com.trim()){
      tb.insertAdjacentHTML('beforeend',`
        <tr><td>${com}</td><td>${spec}</td><td>${unit}</td><td>${price}</td></tr>`);
      c++;
    }
  }
  showNote(`✅ Showing ${c} records for: ${headerRow[i]}`);
}

function downloadPDF(){
  const area=document.getElementById('reportArea');
  if(!window.html2pdf){
    const s=document.createElement('script');
    s.src='https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js';
    s.onload=()=>html2pdf().set({
      margin:5,
      filename:`DA-Price-Report-${new Date().toISOString().slice(0,10)}.pdf`,
      pagebreak:{mode:['avoid-all','css','legacy']}
    }).from(area).save();
    document.body.appendChild(s);
  } else {
    html2pdf().set({
      margin:5,
      filename:`DA-Price-Report-${new Date().toISOString().slice(0,10)}.pdf`,
      pagebreak:{mode:['avoid-all','css','legacy']}
    }).from(area).save();
  }
}
</script>
</body>
</html>
